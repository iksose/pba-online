{{define "content"}}

 <!-- holds all the content -->
<div class="container-fluid">
<div class="row" >
  <div class="col-md-7 col-md-offset-1">
      <div class="row">
      <form role="form">
      <br>
      <input type="text" class="form-control input-lg" placeholder="Enter title" id="new_title">
      <br>
		<textarea name="content" cols="50" rows="15" placeholder="Article" required>

		</textarea>
	    <div class="row">
	    <hr>
        <a href="#" type="button" class="btn btn-success" id="saveEdit">Publish</a>
        <button type="button submit" class="btn btn-success" id="uploadImg">Upload</button>
    </div>
		</form>
    </div>
  <hr>


    <br>

    <!-- <form enctype="multipart/form-data" action="/upload" method="post">
    <input type="file" name="file" />
    <input type="submit" value="upload" />
    </form> -->




    <!-- CROPPER -->

    <div class="container" id="crop-avatar">

        <!-- Current avatar -->
        <h4>src:</h4><h4 id="imgSrc">...</h4>
        <div class="avatar-view" title="Change the avatar">
            <img src="/images/transparent.png" alt="Avatar" class='uploaded_img'>
        </div>

        <!-- Cropping modal -->
        <div class="modal fade" id="avatar-modal" tabindex="-1" role="dialog" aria-labelledby="avatar-modal-label" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form class="avatar-form" method="post" action="/upload" enctype="multipart/form-data">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title" id="avatar-modal-label">Change Avatar</h4>
                        </div>
                        <div class="modal-body">
                            <div class="avatar-body">

                                <!-- Upload image and data -->
                                <div class="avatar-upload">
                                    <input class="avatar-src" name="avatar_src" type="hidden">
                                    <input class="avatar-data" name="avatar_data" type="hidden">
                                    <label for="avatarInput">Local upload</label>
                                    <input class="avatar-input" id="avatarInput" name="avatar_file" type="file">
                                </div>

                                <!-- Crop and preview -->
                                <div class="row">
                                    <div class="col-md-9">
                                        <div class="avatar-wrapper"></div>
                                    </div>
                                    <!-- <div class="col-md-3">
                                        <div class="avatar-preview preview-lg"></div>
                                        <div class="avatar-preview preview-md"></div>
                                        <div class="avatar-preview preview-sm"></div>
                                    </div> -->
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-default" type="button" data-dismiss="modal">Close</button>
                            <button class="btn btn-primary avatar-save" type="submit">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div><!-- /.modal -->

        <!-- Loading state -->
        <div class="loading" tabindex="-1" role="img" aria-label="Loading"></div>
    </div>

    <!-- END CROPPER -->

  </div>
  <div class="col-md-4">
      <h3 class="text-muted">News</h3>
      <hr>
  </div>
<!-- end div class row -->
</div>
<!-- end div class container -->
</div>

<div id="bloodhound">
  <input class="typeahead" type="text" placeholder="States of USA">
</div>

<div id="tags">
</div>


<script>
     // TYPE AHEAD AND Tags


var pbaTags = []
$.get( "/tags", function( data ) {
  pbaTags = data.tags;
  console.log("Got", data.tags)
});

var countries = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  limit: 10,
  prefetch: {
    url: '/tags',
    filter: function(list) {
      return $.map(list.tags, function(country) { return { name: country.title }; });
    }
  }
});
 
// kicks off the loading/processing of `local` and `prefetch`
countries.initialize();
 
// passing in `null` for the `options` arguments will result in the default
// options being used
$('#bloodhound .typeahead').typeahead(null, {
  name: 'countries',
  displayKey: 'name',
  // `ttAdapter` wraps the suggestion engine in an adapter that
  // is compatible with the typeahead jQuery plugin
  source: countries.ttAdapter()
});

var selectedTags = []
var selectedTagIDs = []

$('#bloodhound .typeahead').on('keydown', function(event) {
            // Define tab key
            var e = jQuery.Event("keydown");
            e.keyCode = e.which = 9; // 9 == tab

            if (event.which == 13){ // if pressing enter
                $('.typeahead').trigger(e); // trigger "tab" key - which works as "enter"
                var val = $('.typeahead').typeahead('val');
                console.log(val)
                // check if val is in predetermined array, if so =>
                var matches = _.find(pbaTags, { 'title': val });
                console.log("Matches", matches)
                // also no duplicates
                if(matches != undefined){
                  $('.typeahead').typeahead('close');
                  selectedTags.push(val)
                  selectedTagIDs.push(matches.id)
                  $("#tags").text(selectedTags.toString())
                  window.tags = selectedTags;
                  $('.typeahead').typeahead('val', ""); // clear typeahead
                }
              }
        })



     // END TYPE AHEAD AND TAGS



    var url = "";
    //Get IMG Tags
    function getIMG(){
        var m,
        urls = [],
        str = tinyMCE.get('content').getContent(),
        rex = /<img[^>]+src="?([^"\s]+)"?[^>]*\/>/g;

        while ( m = rex.exec( str ) ) {
            urls.push( m[1] );
        }
        console.log( urls );
        if(urls.length > 0){
            url = urls[0].substring(8,100)
        }
        console.log( url );
    }

function getTrimmed(){
    var yourString = tinyMCE.get('content').getContent({ format: 'text' })
    var maxLength = 130 // maximum number of characters to extract

    //trim the string to the maximum length
    var trimmedString = yourString.substr(0, maxLength);

    //re-trim if we are in the middle of a word
    trimmedString = trimmedString.substr(0, Math.min(trimmedString.length, trimmedString.lastIndexOf(" ")))

    console.log("Trimmed", trimmedString)
    return trimmedString || ""
}

    console.log("Edit this page")
    tinyMCE.init({
    	mode : "textareas",
    	theme : "modern",    //(n.b. no trailing comma, this will be critical as you experiment later)
        plugins : "spellchecker,insertdatetime,preview, image",
        valid_styles : { '*' : 'color,font-size,font-weight,font-style,text-decoration, float' },
        relative_urls: false,
        remove_script_host: true
    });

    document.getElementById("saveEdit").onclick=function(event){
    	event.preventDefault();
        getIMG();
    	var text = {};
    	text.Header = $("#new_title").val()
    	text.Body = tinyMCE.get('content').getContent() // includes formatting tags
    	text.Date = new Date();
    	text.Teaser = getTrimmed();
    	text.Img = url
        // text.Tags = selectedTags
        text.Tags = selectedTagIDs
        console.log("Here's what we're submitting", text)
		$.ajax({
    		type: "POST",
    		contentType: 'application/json; charset=utf-8',
    		url: "/new",
    		data: JSON.stringify(text),
    		dataType: 'json',
    		// success: window.history.go(-1),
    		success: function(){
                console.log("Success!")
    		// window.history.go(-1)
    		},
    		error: function(){console.log("Fuck")}
		});
    }


</script>


<style>

#tinymce > p > img{
    height: 200px;
    width: 380px;
}

.uploaded_img{
    height: 180px;
}

.wut{
    float: left;
    padding-left: 5%;
    padding-right: 5%;
}




.cropper-container {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
       -moz-user-select: none;
        -ms-user-select: none;
            user-select: none;
}

.cropper-container {
    position: relative;
    overflow: hidden;
    background-color: #fff;
}

.cropper-container > img {
    width: 100%;
    height: 100%;
}

.cropper-modal,
.cropper-canvas {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
}

.cropper-modal {
    background-color: #000;
    opacity: .5;
    filter: alpha(opacity=50);
}

.cropper-canvas {
    background-color: #fff;
    opacity: 0;
    filter: alpha(opacity=0);
    cursor: crosshair;
}

.cropper-dragger {
    position: absolute;
    top: 10%;
    left: 10%;
    width: 80%;
    height: 80%;
}

.cropper-preview {
    display: block;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
    overflow: hidden;
    border-color: #69f;
    border-color: rgba(51, 102, 255, .75);
    border-style: solid;
    border-width: 1px;
}

.cropper-preview > img {
    max-width: none !important;
    max-height: none !important;
}

.cropper-dashed {
    position: absolute;
    display: block;
    filter: alpha(opacity=50);
    border: 0 dashed #fff;
    opacity: .5;
}

.cropper-dashed.dashed-h {
    top: 33.3%;
    left: 0;
    width: 100%;
    height: 33.3%;
    border-top-width: 1px;
    border-bottom-width: 1px;
}

.cropper-dashed.dashed-v {
    top: 0;
    left: 33.3%;
    width: 33.3%;
    height: 100%;
    border-right-width: 1px;
    border-left-width: 1px;
}

.cropper-face,
.cropper-line,
.cropper-point {
    position: absolute;
    display: block;
    width: 100%;
    height: 100%;
    filter: alpha(opacity=10);
    opacity: .1;
}

.cropper-face {
    top: 0;
    left: 0;
    cursor: move;
    background-color: #fff;
}

.cropper-line {
    background-color: #69f;
}

.cropper-line.line-e {
    top: 0;
    right: -2px;
    width: 5px;
    cursor: e-resize;
}

.cropper-line.line-n {
    top: -2px;
    left: 0;
    height: 5px;
    cursor: n-resize;
}

.cropper-line.line-w {
    top: 0;
    left: -2px;
    width: 5px;
    cursor: w-resize;
}

.cropper-line.line-s {
    bottom: -2px;
    left: 0;
    height: 5px;
    cursor: s-resize;
}

.cropper-point {
    width: 5px;
    height: 5px;
    background-color: #69f;
    filter: alpha(opacity=75);
    opacity: .75;
}

.cropper-point.point-e {
    top: 49%;
    right: -2px;
    cursor: e-resize;
}

.cropper-point.point-n {
    top: -2px;
    left: 49%;
    cursor: n-resize;
}

.cropper-point.point-w {
    top: 49%;
    left: -2px;
    cursor: w-resize;
}

.cropper-point.point-s {
    bottom: -2px;
    left: 49%;
    cursor: s-resize;
}

.cropper-point.point-ne {
    top: -2px;
    right: -2px;
    cursor: ne-resize;
}

.cropper-point.point-nw {
    top: -2px;
    left: -2px;
    cursor: nw-resize;
}

.cropper-point.point-sw {
    bottom: -2px;
    left: -2px;
    cursor: sw-resize;
}

.cropper-point.point-se {
    right: -2px;
    bottom: -2px;
    width: 20px;
    height: 20px;
    cursor: se-resize;
    filter: alpha(opacity=100);
    opacity: 1;
}

.cropper-point.point-se:before {
    position: absolute;
    right: -50%;
    bottom: -50%;
    display: block;
    width: 200%;
    height: 200%;
    content: " ";
    background-color: #69f;
    filter: alpha(opacity=0);
    opacity: 0;
}

@media (min-width: 768px) {
    .cropper-point.point-se {
        width: 15px;
        height: 15px;
    }
}

@media (min-width: 992px) {
    .cropper-point.point-se {
        width: 10px;
        height: 10px;
    }
}

@media (min-width: 1200px) {
    .cropper-point.point-se {
        width: 5px;
        height: 5px;
        opacity: .75;
        filter: alpha(opacity=75);
    }
}

/* Helper classes for JavaScript */

.cropper-hidden {
    display: none !important;
}

.cropper-invisible {
    position: fixed;
    top: 0;
    left: 0;
    z-index: -1;
    width: auto !important;
    height: auto !important;
    max-width: none !important;
    max-height: none !important;
    opacity: 0;
    filter: alpha(opacity=0);
}


</style>

<script>

(function (factory) {
    if (typeof define === "function" && define.amd) {
        // AMD. Register as anonymous module.
        define(["jquery"], factory);
    } else {
        // Browser globals.
        factory(jQuery);
    }
})(function ($) {

    "use strict";

    var $window = $(window),

        // Helper RegExp
        regexpDirection = /^(\+|\*|e|n|w|s|ne|nw|sw|se)$/i,
        regexpOption = /^(x|y|width|height)$/i,

        // Helper classes
        hiddenClass = "cropper-hidden",
        invisibleClass = "cropper-invisible",

        // Helper functions
        isNumber = function (n) {
            return typeof n === "number";
        },

        // Construstor
        Cropper = function (element, options) {
            this.$image = $(element);
            this.setDefaults(options);
            this.init();
        },

        // Others
        round = Math.round,
        min = Math.min,
        max = Math.max,
        abs = Math.abs,
        num = parseFloat;

    Cropper.prototype = {
        construstor: Cropper,

        setDefaults: function (options) {
            options = $.extend({}, Cropper.defaults, options);

            $.each(options, function (i, n) {
                switch (i) {
                    case "aspectRatio":
                        options[i] = abs(num(n)) || NaN; // 0 -> NaN
                        break;

                    case "minWidth":
                    case "minHeight":
                        options[i] = abs(num(n)) || 0; // NaN -> 0
                        break;

                    case "maxWidth":
                    case "maxHeight":
                        options[i] = abs(num(n)) || Infinity; // NaN -> Infinity
                        break;

                    // No default
                }
            });

            this.defaults = options;
        },

        init: function () {
            var _this = this,
                src = this.$image.attr("src"),
                $clone = $('<img src="' + src + '">'),
                image = {};

            this.$clone && this.$clone.remove();
            this.$clone = $clone;

            $clone.one("load", function () {
                image.naturalWidth = this.naturalWidth || $clone.width();
                image.naturalHeight = this.naturalHeight || $clone.height();
                image.aspectRatio = image.naturalWidth / image.naturalHeight;

                _this.active = true;
                _this.src = src;
                _this.image = image;
                _this.build();
            });

            // Hide and prepend the clone iamge to the document body (Don't append to).
            $clone.addClass(invisibleClass).prependTo("body");
        },

        build: function () {
            var defaults = this.defaults,
                buildEvent,
                $cropper;

            if (this.built) {
                this.unbuild();
            }

            buildEvent = $.Event("build.cropper");
            this.$image.trigger(buildEvent);

            if (buildEvent.isDefaultPrevented()) {
                return;
            }

            // Create cropper elements
            this.$cropper = ($cropper = $(Cropper.template));

            // Hide the original image
            this.$image.addClass(hiddenClass);

            // Show and prepend the clone iamge to the cropper
            this.$clone.removeClass(invisibleClass).prependTo($cropper);

            this.$container = this.$image.parent();
            this.$container.append($cropper);

            this.$modal = $cropper.find(".cropper-modal");
            this.$canvas = $cropper.find(".cropper-canvas");
            this.$dragger = $cropper.find(".cropper-dragger");

            // Init default settings
            this.cropped = true;

            if (!defaults.autoCrop) {
                this.$dragger.addClass(hiddenClass);
                this.cropped = false;
            }

            this.$modal.toggleClass(hiddenClass, !defaults.modal);
            !defaults.dragCrop && this.$canvas.addClass(hiddenClass);
            !defaults.moveable && this.$dragger.find(".cropper-face").addClass(hiddenClass);
            !defaults.resizeable && this.$dragger.find(".cropper-line, .cropper-point").addClass(hiddenClass);

            this.addListener();
            this.initPreview();

            this.built = true;
            this.update();
            this.$image.trigger("built.cropper");
        },

        unbuild: function () {
            if (!this.built) {
                return;
            }

            this.built = false;
            this.removeListener();

            this.$preview.empty();
            this.$preview = null;

            this.$dragger = null;
            this.$canvas = null;
            this.$modal = null;
            this.$container = null;

            this.$cropper.remove();
            this.$cropper = null;
        },

        update: function (data) {
            this.initContainer();
            this.initCropper();
            this.initDragger();

            if (data) {
                this.setData(data, true);
            } else {
                this.setData(this.defaults.data);
            }

        },

        show: function () {
            this.$cropper.removeClass(hiddenClass);
            this.$image.addClass(hiddenClass);
        },

        hide: function () {
            this.$cropper.addClass(hiddenClass);
            this.$image.removeClass(hiddenClass);
        },

        // "enable" method will be removed later
        enable: function () {
            this.show();
        },

        // "disable" method will be removed later
        disable: function () {
            this.hide();
        },

        resize: function () {
            clearTimeout(this.resizing);
            this.resizing = setTimeout($.proxy(this.update, this, this.getData()), 200);
        },

        reset: function (deep) {
            if (!this.cropped) {
                return;
            }

            if (deep) {
                this.defaults.data = {};
            }

            this.dragger = this.cloneDragger();
            this.setData(this.defaults.data);
        },

        release: function () {
            if (!this.cropped) {
                return;
            }

            this.cropped = false;

            this.defaults.done({
                x: 0,
                y: 0,
                width: 0,
                height: 0
            });

            this.$dragger.addClass(hiddenClass);
        },

        destory: function () {
            if (!this.active) {
                return;
            }

            this.unbuild();
            this.$image.removeClass(hiddenClass);
            this.$image.removeData("cropper");
            this.$image = null;
        },

        preview: function () {
            var cropper = this.cropper,
                dragger = this.dragger;

            this.$preview.each(function () {
                var $this = $(this),
                    ratio = $this.width() / dragger.width,
                    styles = {
                        height: round(cropper.height * ratio),
                        marginLeft: - round(dragger.left * ratio),
                        marginTop: - round(dragger.top * ratio),
                        width: round(cropper.width * ratio)
                    };

                $this.find("img").css(styles);
            });
        },

        addListener: function () {
            var defaults = this.defaults;

            this.$image.on({
                "build.cropper": defaults.build,
                "built.cropper": defaults.built,
                "render.cropper": defaults.render
            });

            this.$cropper.on({
                "mousedown touchstart": $.proxy(this.dragstart, this),
                "mousemove touchmove": $.proxy(this.dragmove, this),
                "mouseup mouseleave touchend touchleave": $.proxy(this.dragend, this)
            });

            $window.on("resize", $.proxy(this.resize, this));
        },

        removeListener: function () {
            var defaults = this.defaults;

            this.$image.off({
                "build.cropper": defaults.build,
                "built.cropper": defaults.built,
                "render.cropper": defaults.render
            });

            this.$cropper.off({
                "mousedown touchstart": this.dragstart,
                "mousemove touchmove": this.dragmove,
                "mouseup mouseleave touchend touchleave": this.dragend
            });

            $window.off("resize", this.resize);
        },

        initPreview: function () {
            var preview = this.defaults.preview;

            this.$preview = this.$cropper.find(".cropper-preview");

            if (preview) {
                this.$preview = this.$preview.add(preview);
            }

            this.$preview.html('<img src="' + this.src + '">');
        },

        initContainer: function () {
            var $container = this.$container;

            this.container = {
                width: $container.width(),
                height: $container.height()
            };
        },

        initCropper: function () {
            var container = this.container,
                image = this.image,
                cropper;

            if (((image.naturalWidth * container.height / image.naturalHeight) - container.width) >= 0) {
                cropper = {
                    height: container.width / image.aspectRatio,
                    width: container.width,
                    left: 0
                };

                cropper.top = (container.height - cropper.height) / 2;
            } else {
                cropper = {
                    height: container.height,
                    width: container.height * image.aspectRatio,
                    top: 0
                };

                cropper.left = (container.width - cropper.width) / 2;
            }

            image.ratio = cropper.width / image.naturalWidth;
            image.height = cropper.height;
            image.width = cropper.width;

            this.$cropper.css({
                height: round(cropper.height),
                left: round(cropper.left),
                top: round(cropper.top),
                width: round(cropper.width)
            });

            this.cropper = cropper;
        },

        initDragger: function () {
            var defaults = this.defaults,
                cropper = this.cropper,
                // If not set, use the original aspect ratio of the image.
                aspectRatio = defaults.aspectRatio || this.image.aspectRatio,
                ratio = this.image.ratio,
                dragger;

            if (((cropper.height * aspectRatio) - cropper.width) >= 0) {
                dragger = {
                    height: cropper.width / aspectRatio,
                    width: cropper.width,
                    left: 0,
                    top: (cropper.height - (cropper.width / aspectRatio)) / 2,
                    maxWidth: cropper.width,
                    maxHeight: cropper.width / aspectRatio
                };
            } else {
                dragger = {
                    height: cropper.height,
                    width: cropper.height * aspectRatio,
                    left: (cropper.width - (cropper.height * aspectRatio)) / 2,
                    top: 0,
                    maxWidth: cropper.height * aspectRatio,
                    maxHeight: cropper.height
                };
            }

            dragger.maxWidth = min(dragger.maxWidth, defaults.maxWidth * ratio);
            dragger.maxHeight = min(dragger.maxHeight, defaults.maxHeight * ratio);
            dragger.minWidth = max(0, defaults.minWidth * ratio);
            dragger.minHeight = max(0, defaults.minHeight * ratio);

            // Center the dragger by default
            dragger.height *= 0.8;
            dragger.width *= 0.8;
            dragger.left = (cropper.width - dragger.width) / 2;
            dragger.top = (cropper.height - dragger.height) / 2;

            this.defaultDragger = dragger;
            this.dragger = this.cloneDragger();
        },

        cloneDragger: function () {
            return $.extend({}, this.defaultDragger);
        },

        renderDragger: function () {
            var dragger = this.dragger,
                cropper = this.cropper,
                renderEvent;

            dragger.width = dragger.width > dragger.maxWidth ? dragger.maxWidth :
                            dragger.width < dragger.minWidth ? dragger.minWidth :
                            dragger.width;

            dragger.height = dragger.height > dragger.maxHeight ? dragger.maxHeight :
                            dragger.height < dragger.minHeight ? dragger.minHeight :
                            dragger.height;

            dragger.maxLeft = cropper.width - dragger.width;
            dragger.maxTop = cropper.height - dragger.height;

            dragger.left = dragger.left > dragger.maxLeft ? dragger.maxLeft :
                            dragger.left < 0 ? 0 :
                            dragger.left;

            dragger.top = dragger.top > dragger.maxTop ? dragger.maxTop :
                            dragger.top < 0 ? 0 :
                            dragger.top;

            // Trigger the render event
            renderEvent = $.Event("render.cropper");
            this.$image.trigger(renderEvent);

            if (renderEvent.isDefaultPrevented()) {
                return;
            }

            // Re-render the dragger
            this.dragger = dragger;
            this.defaults.done(this.getData());

            this.$dragger.css({
                height: round(dragger.height),
                left: round(dragger.left),
                top: round(dragger.top),
                width: round(dragger.width)
            });

            this.preview();
        },

        setData: function (data, once) {
            var cropper = this.cropper,
                dragger = this.dragger,
                aspectRatio = this.defaults.aspectRatio;

            if (!this.built || typeof data === "undefined") {
                return;
            }

            if (data === null || $.isEmptyObject(data)) {
                dragger = this.cloneDragger();
            }

            if ($.isPlainObject(data) && !$.isEmptyObject(data)) {

                if (!once) {
                    this.defaults.data = data;
                }

                data = this.transformData(data);

                if (isNumber(data.x) && data.x <= cropper.width) {
                    dragger.left = data.x;
                }

                if (isNumber(data.y) && data.y <= cropper.height) {
                    dragger.top = data.y;
                }

                if (aspectRatio) {
                    if (isNumber(data.width) && data.width <= cropper.width) {
                        dragger.width = data.width;
                        dragger.height = dragger.width / aspectRatio;
                    } else if (isNumber(data.height) && data.height <= cropper.height) {
                        dragger.height = data.height;
                        dragger.width = dragger.height * aspectRatio;
                    }
                } else {
                    if (isNumber(data.width) && data.width <= cropper.width) {
                        dragger.width = data.width;
                    }

                    if (isNumber(data.height) && data.height <= cropper.height) {
                        dragger.height = data.height;
                    }
                }
            }

            this.dragger = dragger;
            this.renderDragger();
        },

        getData: function () {
            var dragger = this.dragger,
                data = {};

            if (this.built) {
                data = {
                    x: dragger.left,
                    y: dragger.top,
                    width: dragger.width,
                    height: dragger.height
                };

                data = this.transformData(data, true);
            }

            return data;
        },

        transformData: function (data, reverse) {
            var ratio = this.image.ratio,
                result = {};

            $.each(data, function (i, n) {
                n = num(n);

                if (regexpOption.test(i) && !isNaN(n)) {
                    result[i] = round(reverse ? n / ratio : n * ratio);
                }
            });

            return result;
        },

        setAspectRatio: function (aspectRatio) {
            var freeRatio = aspectRatio === "auto";

            aspectRatio = num(aspectRatio);

            if (freeRatio || (!isNaN(aspectRatio) && aspectRatio > 0)) {
                this.defaults.aspectRatio = freeRatio ? NaN : aspectRatio;

                if (this.built) {
                    this.initDragger();
                    this.renderDragger();
                }
            }
        },

        setImgSrc: function (src) {
            if (src && src !== this.src) {
                this.$image.attr("src", src);
                this.init();
            }
        },

        getImgInfo: function () {
            return this.image || {};
        },

        dragstart: function (event) {
            var touches = (event.originalEvent || event).touches,
                e = event,
                touching,
                direction;

            if (touches && touches.length === 1) {
                e = touches[0];
                this.touchId = e.identifier;
                touching = true;
            }

            direction = $(e.target).data("direction");

            if (regexpDirection.test(direction)) {
                this.direction = direction;
                this.startX = e.pageX;
                this.startY = e.pageY;

                if (direction === "+") {
                    this.cropping = true;
                    this.$modal.removeClass(hiddenClass);
                }

                // "dragstart" event will be removed later
                this.$image.trigger("dragstart.cropper");

                // Prevent the default effect on mobile browser
                touching && event.preventDefault();
            }
        },

        dragmove: function (event) {
            var touches = (event.originalEvent || event).changedTouches,
                e = event,
                touching;

            if (touches && touches.length === 1) {
                e = touches[0];
                touching = true;

                if (e.identifier !== this.touchId) {
                    return;
                }
            }

            if (this.direction) {
                this.endX = e.pageX;
                this.endY = e.pageY;

                // "dragmove" event will be removed later
                this.$image.trigger("dragmove.cropper");

                // Prevent the default effect on mobile browser
                touching && event.preventDefault();
                this.dragging();
            }
        },

        dragend: function (event) {
            var touches = (event.originalEvent || event).changedTouches,
                e = event,
                touching;

            if (touches && touches.length === 1) {
                e = touches[0];
                touching = true;

                if (e.identifier !== this.touchId) {
                    return;
                }
            }

            if (this.direction) {

                if (this.cropping) {
                    this.cropping = false;
                    this.$modal.toggleClass(hiddenClass, !this.defaults.modal);
                }

                this.direction = "";

                // "dragend" event will be removed later
                this.$image.trigger("dragend.cropper");

                // Prevent the default effect on mobile browser
                touching && event.preventDefault();
            }
        },

        dragging: function () {
            var direction = this.direction,
                dragger = this.dragger,
                aspectRatio = this.defaults.aspectRatio,
                range = {
                    x: this.endX - this.startX,
                    y: this.endY - this.startY
                },
                offset;

            if (aspectRatio) {
                range.X = range.y * aspectRatio;
                range.Y = range.x / aspectRatio;
            }

            switch (direction) {

                // cropping
                case "+":
                    if (range.x && range.y) {
                        offset = this.$cropper.offset();
                        dragger.left = this.startX - offset.left;
                        dragger.top = this.startY - offset.top;
                        dragger.width = 0;
                        dragger.height = 0;

                        if (range.x > 0) {
                            this.direction = range.y > 0 ? "se" : "ne";
                        } else {
                            this.direction = range.y > 0 ? "sw" : "nw";
                        }

                        // Show the dragger if is hidden
                        if (!this.cropped) {
                            this.cropped = true;
                            this.$dragger.removeClass(hiddenClass);
                        }
                    }

                    break;

                // moving
                case "*":
                    dragger.left += range.x;
                    dragger.top += range.y;

                    break;

                // resizing
                case "e":
                    dragger.width += range.x;

                    if (aspectRatio) {
                        dragger.height = dragger.width / aspectRatio;
                        dragger.top -= range.Y / 2;
                    }

                    if (dragger.width < 0) {
                        this.direction = "w";
                        dragger.width = 0;
                    }

                    break;

                case "n":
                    dragger.height -= range.y;
                    dragger.top += range.y;

                    if (aspectRatio) {
                        dragger.width = dragger.height * aspectRatio;
                        dragger.left += range.X / 2;
                    }

                    if (dragger.height < 0) {
                        this.direction = "s";
                        dragger.height = 0;
                    }

                    break;

                case "w":
                    dragger.width -= range.x;
                    dragger.left += range.x;

                    if (aspectRatio) {
                        dragger.height = dragger.width / aspectRatio;
                        dragger.top += range.Y / 2;
                    }

                    if (dragger.width < 0) {
                        this.direction = "e";
                        dragger.width = 0;
                    }

                    break;

                case "s":
                    dragger.height += range.y;

                    if (aspectRatio) {
                        dragger.width = dragger.height * aspectRatio;
                        dragger.left -= range.X / 2;
                    }

                    if (dragger.height < 0) {
                        this.direction = "n";
                        dragger.height = 0;
                    }

                    break;

                case "ne":
                    dragger.height -= range.y;
                    dragger.top += range.y;

                    if (aspectRatio) {
                        dragger.width = dragger.height * aspectRatio;
                    } else {
                        dragger.width += range.x;
                    }

                    if (dragger.height < 0) {
                        this.direction = "sw";
                        dragger.height = 0;
                        dragger.width = 0;
                    }

                    break;

                case "nw":
                    dragger.height -= range.y;
                    dragger.top += range.y;

                    if (aspectRatio) {
                        dragger.width = dragger.height * aspectRatio;
                        dragger.left += range.X;
                    } else {
                        dragger.width -= range.x;
                        dragger.left += range.x;
                    }

                    if (dragger.height < 0) {
                        this.direction = "se";
                        dragger.height = 0;
                        dragger.width = 0;
                    }

                    break;

                case "sw":
                    dragger.width -= range.x;
                    dragger.left += range.x;

                    if (aspectRatio) {
                        dragger.height = dragger.width / aspectRatio;
                    } else {
                        dragger.height += range.y;
                    }

                    if (dragger.width < 0) {
                        this.direction = "ne";
                        dragger.height = 0;
                        dragger.width = 0;
                    }

                    break;

                case "se":
                    dragger.width += range.x;

                    if (aspectRatio) {
                        dragger.height = dragger.width / aspectRatio;
                    } else {
                        dragger.height += range.y;
                    }

                    if (dragger.width < 0) {
                        this.direction = "nw";
                        dragger.height = 0;
                        dragger.width = 0;
                    }

                    break;

                // No default
            }

            this.renderDragger();

            // Override
            this.startX = this.endX;
            this.startY = this.endY;
        }
    };

    Cropper.template = [
        '<div class="cropper-container">',
            '<div class="cropper-modal"></div>',
            '<div class="cropper-canvas" data-direction="+"></div>',
            '<div class="cropper-dragger">',
                '<span class="cropper-preview"></span>',
                '<span class="cropper-dashed dashed-h"></span>',
                '<span class="cropper-dashed dashed-v"></span>',
                '<span class="cropper-face" data-direction="*"></span>',
                '<span class="cropper-line line-e" data-direction="e"></span>',
                '<span class="cropper-line line-n" data-direction="n"></span>',
                '<span class="cropper-line line-w" data-direction="w"></span>',
                '<span class="cropper-line line-s" data-direction="s"></span>',
                '<span class="cropper-point point-e" data-direction="e"></span>',
                '<span class="cropper-point point-n" data-direction="n"></span>',
                '<span class="cropper-point point-w" data-direction="w"></span>',
                '<span class="cropper-point point-s" data-direction="s"></span>',
                '<span class="cropper-point point-ne" data-direction="ne"></span>',
                '<span class="cropper-point point-nw" data-direction="nw"></span>',
                '<span class="cropper-point point-sw" data-direction="sw"></span>',
                '<span class="cropper-point point-se" data-direction="se"></span>',
            '</div>',
        '</div>'
    ].join("");

    Cropper.defaults = {
        // Basic
        aspectRatio: "auto",
        data: {}, // Allow options: x, y, width, height
        done: $.noop,
        // preview: undefined,

        // Toggles
        autoCrop: true,
        dragCrop: true,
        modal: true,
        moveable: true,
        resizeable: true,

        // Dimensions
        maxWidth: Infinity,
        maxHeight: Infinity,
        minWidth: 0,
        minHeight: 0
    };

    Cropper.setDefaults = function (options) {
        $.extend(Cropper.defaults, options);
    };

    // Reference the old cropper
    Cropper.other = $.fn.cropper;

    // Register as jQuery plugin
    $.fn.cropper = function (options, settings) {
        var result = this;

        this.each(function () {
            var $this = $(this),
                data = $this.data("cropper");

            if (!data && $.isPlainObject(options)) {
                $this.data("cropper", (data = new Cropper(this, options)));
            }

            if (typeof options === "string" && $.isFunction(data[options])) {
                result = data[options](settings);
            }
        });

        return (typeof result !== "undefined" ? result : this);
    };

    $.fn.cropper.constructor = Cropper;
    $.fn.cropper.setDefaults = Cropper.setDefaults;

    // No conflict
    $.fn.cropper.noConflict = function () {
        $.fn.cropper = Cropper.other;
        return this;
    };
});

(function (factory) {
    if (typeof define === "function" && define.amd) {
        define(["jquery"], factory);
    } else {
        factory(jQuery);
    }
})(function ($) {

    "use strict";

    var log = function (o) {
            try {
                console.log(o)
            } catch (e) {}
        };

    function CropAvatar($element) {
        this.$container = $element;

        this.$avatarView = this.$container.find(".avatar-view");
        this.$avatar = this.$avatarView.find("img");
        this.$avatarModal = this.$container.find("#avatar-modal");
        this.$loading = this.$container.find(".loading");

        this.$avatarForm = this.$avatarModal.find(".avatar-form");
        this.$avatarUpload = this.$avatarForm.find(".avatar-upload");
        this.$avatarSrc = this.$avatarForm.find(".avatar-src");
        this.$avatarData = this.$avatarForm.find(".avatar-data");
        this.$avatarInput = this.$avatarForm.find(".avatar-input");
        this.$avatarSave = this.$avatarForm.find(".avatar-save");

        this.$avatarWrapper = this.$avatarModal.find(".avatar-wrapper");
        this.$avatarPreview = this.$avatarModal.find(".avatar-preview");

        this.init();
        log(this);
    }

    CropAvatar.prototype = {
        constructor: CropAvatar,

        support: {
            fileList: !!$("<input type=\"file\">").prop("files"),
            fileReader: !!window.FileReader,
            formData: !!window.FormData
        },

        init: function () {
            this.support.datauri = this.support.fileList && this.support.fileReader;

            if (!this.support.formData) {
                this.initIframe();
            }

            this.initTooltip();
            this.initModal();
            this.addListener();
        },

        addListener: function () {
            document.getElementById('uploadImg').addEventListener('click', function(event) {
                console.log("Derp")
                $.proxy(this.change, this);
            })
            this.$avatarView.on("click", $.proxy(this.click, this));
            this.$avatarInput.on("change", $.proxy(this.change, this));
            this.$avatarForm.on("submit", $.proxy(this.submit, this));
        },

        removeListener: function () {
        },

        initTooltip: function () {
            this.$avatarView.tooltip({
                placement: "bottom"
            });
        },

        initModal: function () {
            this.$avatarModal.modal("hide");
            this.initPreview();
        },

        initPreview: function () {
            var url = this.$avatar.attr("src");

            this.$avatarPreview.empty().html('<img src="' + url + '">');
        },

        initIframe: function () {
            var iframeName = "avatar-iframe-" + Math.random().toString().replace(".", ""),
                $iframe = $('<iframe name="' + iframeName + '" style="display:none;"></iframe>'),
                firstLoad = true,
                _this = this;

            this.$iframe = $iframe;
            this.$avatarForm.attr("target", iframeName).after($iframe);

            this.$iframe.on("load", function () {
                var data,
                    win,
                    doc;

                try {
                    win = this.contentWindow;
                    doc = this.contentDocument;

                    doc = doc ? doc : win.document;
                    data = doc ? doc.body.innerText : null;
                } catch (e) {}

                if (data) {
                    _this.submitDone(data);
                } else {
                    if (firstLoad) {
                        firstLoad = false;
                    } else {
                        _this.submitFail("Image upload failed!");
                    }
                }

                _this.submitEnd();
            });
        },

        click: function () {
            this.$avatarModal.modal("show");
        },

        change: function () {
            var files,
                file;

            if (this.support.datauri) {
                files = this.$avatarInput.prop("files");

                if (files.length > 0) {
                    file = files[0];

                    if (this.isImageFile(file)) {
                        this.read(file);
                    }
                }
            } else {
                file = this.$avatarInput.val();

                if (this.isImageFile(file)) {
                    this.syncUpload();
                }
            }
        },

        submit: function () {
            if (!this.$avatarSrc.val() && !this.$avatarInput.val()) {
                return false;
            }

            if (this.support.formData) {
                this.ajaxUpload();
                return false;
            }
        },

        isImageFile: function (file) {
            if (file.type) {
                return /^image\/\w+$/.test(file.type);
            } else {
                return /\.(jpg|jpeg|png|gif)$/.test(file);
            }
        },

        read: function (file) {
            var _this = this,
                fileReader = new FileReader();

            fileReader.readAsDataURL(file);

            fileReader.onload = function () {
                _this.url = this.result
                _this.startCropper();
            };
        },

        startCropper: function () {
            var _this = this;

            if (this.active) {
                this.$img.cropper("setImgSrc", this.url);
            } else {
                this.$img = $('<img src="' + this.url + '">');
                this.$avatarWrapper.empty().html(this.$img);
                this.$img.cropper({
                    aspectRatio: 16/9,
                    preview: this.$avatarPreview.selector,
                    done: function (data) {
                        var json = [
                            '{"x":' + data.x,
                            '"y":' + data.y,
                            '"height":' + data.height,
                            '"width":' + data.width + "}"
                        ].join();

                        _this.$avatarData.val(json);
                    }
                });

                this.active = true;
            }
        },

        stopCropper: function () {
            if (this.active) {
                this.$img.cropper("disable");
                this.$img.data("cropper", null).remove();
                this.active = false;
            }
        },

        ajaxUpload: function () {
            var url = this.$avatarForm.attr("action"),
                data = new FormData(this.$avatarForm[0]),
                _this = this;

            $.ajax(url, {
                type: "post",
                data: data,
                processData: false,
                contentType: false,

                beforeSend: function () {
                    _this.submitStart();
                },

                success: function (data) {
                    _this.submitDone(data);
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    _this.submitFail(textStatus || errorThrown);
                },

                complete: function () {
                    _this.submitEnd();
                }
            });
        },

        syncUpload: function () {
            this.$avatarSave.click();
        },

        submitStart: function () {
            this.$loading.fadeIn();
        },

        submitDone: function (data) {
            log(data);

            try {
                data = $.parseJSON(data);
            } catch (e) {};
            console.log("Derr", data, data.state)
            if (data.success) {

                    this.url = data.data;
                    this.uploaded = true;
                    this.$avatarSrc.val("www.google.com");
                    this.startCropper();
                    $('#avatar-modal').modal('hide')
                    this.$avatar.attr("src", data.data);
                    $("#imgSrc").text(data.data)

                //     // if (this.support.datauri || this.uploaded) {
                //     //     this.uploaded = false;
                //     //     this.cropDone();
                //     // } else {
                //         this.uploaded = true;
                //         this.$avatarSrc.val(this.url);
                //         this.startCropper();
                //     // }
                //
                //     this.$avatarInput.val("");
                // } //else if (data.message) {
                //     // this.alert(data.message);
                // // }
            } else {
                this.alert("Failed to response");
            }
        },

        submitFail: function (msg) {
            this.alert(msg);
        },

        submitEnd: function () {
            this.$loading.fadeOut();
        },

        cropDone: function () {
            this.$avatarSrc.val("");
            this.$avatarData.val("");
            this.$avatar.attr("src", this.url);
            this.stopCropper();
            this.$avatarModal.modal("hide");
        },

        alert: function (msg) {
            var $alert = [
                '<div class="alert alert-danger avater-alert">',
                    '<button type="button" class="close" data-dismiss="alert">&times;</button>',
                    msg,
                '</div>'
                ].join("");

            this.$avatarUpload.after($alert);
        }
    };

    $(function () {
        var example = new CropAvatar($("#crop-avatar"));
    });
});

</script>


{{end}}
